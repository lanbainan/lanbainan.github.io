<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Linux防火墙-iptables/firewalld | 梦梦的小站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="iptablesnetfilter/iptables（简称为iptables）组成Linux平台下的包过滤防火墙，具有完成封包过滤、封包重定向和网络地址转换（NAT）等功能。netfilter是Linux 核心中一个通用架构，它提供了一系列的”表”(tables)，每个表由若干”链”(chains)组成，而每条链中可以有一条或数条规则(rule)组成。可以这样来理解，netfilter是表的容器，">
<meta name="keywords" content="安全测试,防火墙">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux防火墙-iptables&#x2F;firewalld">
<meta property="og:url" content="http://www.lanbainan.cn/2019/04/04/2019-04-04/index.html">
<meta property="og:site_name" content="梦梦的小站">
<meta property="og:description" content="iptablesnetfilter/iptables（简称为iptables）组成Linux平台下的包过滤防火墙，具有完成封包过滤、封包重定向和网络地址转换（NAT）等功能。netfilter是Linux 核心中一个通用架构，它提供了一系列的”表”(tables)，每个表由若干”链”(chains)组成，而每条链中可以有一条或数条规则(rule)组成。可以这样来理解，netfilter是表的容器，">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://i.loli.net/2019/04/04/5ca572fc35954.png">
<meta property="og:image" content="https://i.loli.net/2019/04/04/5ca576af89756.png">
<meta property="og:image" content="https://i.loli.net/2019/04/04/5ca577a6c7cdf.png">
<meta property="og:image" content="https://i.loli.net/2019/04/04/5ca5949fc4ce4.png">
<meta property="og:image" content="https://i.loli.net/2019/04/07/5ca9d3a835829.png">
<meta property="og:image" content="https://i.loli.net/2019/04/08/5caabeb25b5e0.png">
<meta property="og:image" content="https://i.loli.net/2019/04/04/5ca58a69f1e58.png">
<meta property="og:updated_time" content="2019-04-08T05:09:22.984Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux防火墙-iptables&#x2F;firewalld">
<meta name="twitter:description" content="iptablesnetfilter/iptables（简称为iptables）组成Linux平台下的包过滤防火墙，具有完成封包过滤、封包重定向和网络地址转换（NAT）等功能。netfilter是Linux 核心中一个通用架构，它提供了一系列的”表”(tables)，每个表由若干”链”(chains)组成，而每条链中可以有一条或数条规则(rule)组成。可以这样来理解，netfilter是表的容器，">
<meta name="twitter:image" content="https://i.loli.net/2019/04/04/5ca572fc35954.png">
  
  
    <link rel="icon" href="/img/830.jpg">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/831.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">EV</a></h1>
        </hgroup>

        
        <p class="header-subtitle">只要没完蛋，就还可以继续。</p>
        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/categories/信息安全">信息安全</a></li>
                        
                            <li><a href="/categories/python">python</a></li>
                        
                            <li><a href="/categories/杂项">杂项</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=6oaLhIiLg46PnouEhouEjaqbm8SJhYc" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/lanbainan" title="github">github</a>
                            
                                <a class="fl zhihu" target="_blank" href="https://www.zhihu.com/people/lan-bai-83-69/activities" title="zhihu">zhihu</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/ARP/" style="font-size: 10px;">ARP</a> <a href="/tags/Sql注入/" style="font-size: 10px;">Sql注入</a> <a href="/tags/hexo/" style="font-size: 12px;">hexo</a> <a href="/tags/linux/" style="font-size: 16px;">linux</a> <a href="/tags/python/" style="font-size: 14px;">python</a> <a href="/tags/安全测试/" style="font-size: 20px;">安全测试</a> <a href="/tags/密码学/" style="font-size: 12px;">密码学</a> <a href="/tags/工具/" style="font-size: 18px;">工具</a> <a href="/tags/爬虫/" style="font-size: 12px;">爬虫</a> <a href="/tags/防火墙/" style="font-size: 10px;">防火墙</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a> <a href="/tags/靶机实验/" style="font-size: 16px;">靶机实验</a>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">励志成为一个职业吹牛大王</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">EV</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/831.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">EV</a></h1>
            </hgroup>
            
            <p class="header-subtitle">只要没完蛋，就还可以继续。</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/categories/信息安全">信息安全</a></li>
                
                    <li><a href="/categories/python">python</a></li>
                
                    <li><a href="/categories/杂项">杂项</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=6oaLhIiLg46PnouEhouEjaqbm8SJhYc" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/lanbainan" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com/people/lan-bai-83-69/activities" title="zhihu">zhihu</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-2019-04-04" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/04/04/2019-04-04/" class="article-date">
      <time datetime="2019-04-03T16:00:00.000Z" itemprop="datePublished">2019-04-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux防火墙-iptables/firewalld
    </h1>
  

      
      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/信息安全/">信息安全</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/安全测试/">安全测试</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/防火墙/">防火墙</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><p>netfilter/iptables（简称为iptables）组成Linux平台下的包过滤防火墙，具有完成封包过滤、封包重定向和网络地址转换（NAT）等功能。netfilter是Linux 核心中一个通用架构，它提供了一系列的”表”(tables)，每个表由若干”链”(chains)组成，而每条链中可以有一条或数条规则(rule)组成。可以这样来理解，netfilter是表的容器，表是链的容器，而链又是规则的容器。<br><a id="more"></a><br><a href="https://www.cnblogs.com/kevingrace/p/6265113.html" target="_blank" rel="noopener">iptables规则梳理</a></p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p><strong>iptables语法</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">语法：iptables [-t table] command [match] [-j target/jump]</span><br></pre></td></tr></table></figure></p>
<p>1）[-t table] 指定规则表<br>-t 参数用来，内建的规则表有三个，分别是：nat、mangle 和 filter，当未指定规则表时，则一律视为是 filter。个规则表的功能如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nat：此规则表拥有 PREROUTING 和 POSTROUTING 两个规则链，主要功能为进行一对一、一对多、多对多等网址转换工作（SNAT、DNAT），这个规则表除了作网址转换外，请不要做其它用途。</span><br><span class="line">mangle：此规则表拥有 PREROUTING、FORWARD 和 POSTROUTING 三个规则链。除了进行网址转换工作会改写封包外，在某些特殊应用可能也必须去改写封包（TTL、TOS）或者是设定markMARK（将封包作记号，以进行后续的过滤），这时就必须将这些工作定义在 mangle 规则表中，由于使用率不高，这里不讨论 mangle 的用法。</span><br><span class="line">filter：这个规则表是默认规则表，拥有 INPUT、FORWARD 和 OUTPUT 三个规则链，这个规则表顾名思义是用来进行封包过滤的处理动作（例如：DROP、 LOG、 ACCEPT 或 REJECT），需要将基本规则都建立在此规则表中。</span><br></pre></td></tr></table></figure></p>
<p>2）command 常用命令列表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">命令：-A, --append；范例：iptables -A INPUT ...；说明：新增规则到某个规则链中，该规则将会成为规则链中的最后一条规则。</span><br><span class="line">命令：-D, --delete；范例：iptables -D INPUT --dport 80 -j DROP，iptables -D INPUT 1；说明：从某个规则链中删除一条规则，可以输入完整规则，或直接指定规则编号加以删除。</span><br><span class="line">命令：-R, --replace；范例：iptables -R INPUT 1 -s 192.168.0.1 -j DROP；说明：取代现行规则，规则被取代后并不会改变顺序。</span><br><span class="line">命令：-I, --insert；范例：iptables -I INPUT 1 --dport 80 -j ACCEPT；说明：插入一条规则，原本该位置上的规则将会往后移动一个顺位。</span><br><span class="line">命令：-L, --list；范例1 ：iptables -L INPUT，说明： 列出某规则链中的所有规则；范例2 iptables -t nat -L ，说明：列出nat表所有链中的所有规则。</span><br><span class="line">命令：-F, --flush；范例：iptables -F INPUT；说明：删除filter表中INPUT链的所有规则。</span><br><span class="line">命令：-Z, --zero；范例：iptables -Z INPUT；说明：将封包计数器归零。封包计数器是用来计算同一封包出现次数，是过滤阻断式攻击不可或缺的工具。</span><br><span class="line">命令：-N, --new-chain；范例：iptables -N allowed；说明：定义新的规则链。</span><br><span class="line">命令：-X, --delete-chain；范例：iptables -X allowed；说明：删除某个规则链。</span><br><span class="line">命令： -P, --policy；范例：iptables -P INPUT DROP；说明：定义过滤政策。 也就是未符合过滤条件之封包， 默认的处理方式。</span><br><span class="line">命令：-E, --rename-chain；范例：iptables -E allowed disallowed；说明：修改某自定义规则链的名称。</span><br></pre></td></tr></table></figure></p>
<p>3）[match] 常用封包匹配参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">参数：-p, --protocol；范例：iptables -A INPUT -p tcp；说明：匹配通讯协议类型是否相符，可以使用 ! 运算符进行反向匹配，例如：-p !tcp，意思是指除 tcp 以外的其它类型，如udp、icmp等；如果要匹配所有类型，则可以使用 all 关键词，例如：-p all。</span><br><span class="line">参数：-s, --src, --source；范例：iptables -A INPUT -s 192.168.1.1；说明：用来匹配封包的来源 IP，可以匹配单机或网络，匹配网络时请用数字来表示 子网掩码，例如：-s 192.168.0.0/24，匹配 IP 时可以使用 ! 运算符进行反向匹配，例如：-s !192.168.0.0/24。</span><br><span class="line">参数：-d, --dst, --destination；范例：iptables -A INPUT -d 192.168.1.1；说明：用来匹配封包的目的地 IP，设定方式同上。</span><br><span class="line">参数：-i, --in-interface；范例：iptables -A INPUT -i eth0；说明：用来匹配封包是从哪块网卡进入，可以使用通配字符 + 来做大范围匹配，例如：-i eth+ 表示所有的 ethernet 网卡，也可以使用 ! 运算符进行反向匹配，例如：-i !eth0。</span><br><span class="line">参数：-o, --out-interface；范例：iptables -A FORWARD -o eth0；说明：用来匹配封包要从哪 块网卡送出，设定方式同上。</span><br><span class="line">参数：--sport, --source-port；范例：iptables -A INPUT -p tcp --sport 22；说明：用来匹配封包的源端口，可以匹配单一端口，或是一个范围，例如：--sport 22:80表示从 22 到 80 端口之间都算是符合条件，如果要匹配不连续的多个端口，则必须使用 --multiport 参数，详见后文。匹配端口号时，可以使用 ! 运算符进行反向匹配。</span><br><span class="line">参数：--dport, --destination-port；范例：iptables -A INPUT -p tcp --dport 22；说明：用来匹配封包的目的地端口号，设定方式同上</span><br><span class="line">参数：--tcp-flags；范例：iptables -p tcp --tcp-flags SYN,FIN,ACK SYN；说明：匹配 TCP 封包的状态标志，参数分为两个部分，第一个部分列举出想 匹配的标志，第二部分则列举前述标志中哪些有被设置，未被列举的标志必须是空的。TCP 状态标志包括：SYN（同步）、ACK（应答）、FIN（结束）、RST（重设）、URG（紧急） 、PSH（强迫推送） 等均可使用于参数中，除此之外还可以使用关键词 ALL 和 NONE 进行匹配。匹配标志时，可以使用 ! 运算符行反向匹配。</span><br><span class="line">参数：--syn；范例：iptables -p tcp --syn；说明：用来表示TCP通信协议中，SYN位被打开，而ACK与FIN位关闭的分组，即TCP的初始连接，与 iptables -p tcp --tcp-flags SYN,FIN,ACK SYN 的作用完全相同，如果使用 !运算符，可用来 匹配非要求连接封包。</span><br><span class="line">参数：-m multiport --source-port；范例：iptables -A INPUT -p tcp -m multiport --source-port 22,53,80,110；说明：用来匹配不连续的多个源端口，一次最多可以匹配 15 个端口，可以使用 ! 运算符进行反向匹配。</span><br><span class="line">参数：-m multiport --destination-port；范例：iptables -A INPUT -p tcp -m multiport --destination-port 22,53,80,110；说明：用来匹配不连续的多个目的地端口号，设定方式同上。</span><br><span class="line">参数：-m multiport --port；范例：iptables -A INPUT -p tcp -m multiport --port 22,53,80,110；说明：这个参数比较特殊，用来匹配源端口和目的端口号相同的封包，设定方式同上。注意：在本范例中，如果来源端口号为 80目的地端口号为 110，这种封包并不算符合条件。</span><br><span class="line">参数：--icmp-type；范例：iptables -A INPUT -p icmp --icmp-type 8；说明：用来匹配 ICMP 的类型编号，可以使用代码或数字编号来进行 匹配。请打 iptables -p icmp --help 来查看有哪些代码可用。</span><br><span class="line">参数：-m limit --limit；范例：iptables -A INPUT -m limit --limit 3/hour；说明：用来匹配某段时间内封包的平均流量，上面的例子是用来 匹配：每小时平均流量是否超过一次 3 个封包。 除了每小时平均次外，也可以每秒钟、每分钟或每天平均一次，默认值为每小时平均一次，参数如后： /second、 /minute、/day。 除了进行封 包数量的匹配外，设定这个参数也会在条件达成时，暂停封包的匹配动作，以避免因骇客使用洪水攻击法，导致服务被阻断。</span><br><span class="line">参数：--limit-burst；范例：iptables -A INPUT -m limit --limit-burst 5；说明：用来匹配瞬间大量封包的数量，上面的例子是用来匹配一次同时涌入的封包是否超过 5 个（这是默认值），超过此上限的封包将被直接丢弃。使用效果同上。</span><br><span class="line">参数：-m mac --mac-source；范例：iptables -A INPUT -m mac --mac-source 00:00:00:00:00:01；说明：用来匹配封包来源网络接口的硬件地址，这个参数不能用在 OUTPUT 和 POSTROUTING 规则链上，这是因为封包要送到网 卡后，才能由网卡驱动程序透过 ARP 通讯协议查出目的地的 MAC 地址，所以 iptables 在进行封包匹配时，并不知道封包会送到哪个网络接口去。</span><br><span class="line">参数：--mark；范例：iptables -t mangle -A INPUT -m mark --mark 1；说明：用来匹配封包是否被表示某个号码，当封包被匹配成功时，可以透过 MARK 处理动作，将该封包标示一个号码，号码最大不可以超过 4294967296。</span><br><span class="line">参数：-m owner --uid-owner；范例：iptables -A OUTPUT -m owner --uid-owner 500；说明：用来匹配来自本机的封包，是否为某特定使用者所产生的，这样可以避免服务器使用 root 或其它身分将敏感数据传送出，可以降低系统被骇的损失。可惜这个功能无法 匹配出来自其它主机的封包。</span><br><span class="line">参数：-m owner --gid-owner；范例：iptables -A OUTPUT -m owner --gid-owner 0；说明：用来匹配来自本机的封包，是否为某特定使用者群组所产生的，使用时机同上。</span><br><span class="line">参数：-m owner --pid-owner；范例：iptables -A OUTPUT -m owner --pid-owner 78；说明：用来匹配来自本机的封包，是否为某特定进程所产生的，使用时机同上。</span><br><span class="line">参数：m owner --sid-owner；范例：iptables -A OUTPUT -m owner --sid-owner 100；说明 用来匹配来自本机的封包，是否为某特定 连接（Session ID）的响应封包，使用时机同上。</span><br><span class="line">参数：-m state --state；范例：iptables -A INPUT -m state --state RELATED,ESTABLISHED；说明：用来匹配连接状态， 连接状态共有四种：INVALID、ESTABLISHED、NEW 和 RELATED。</span><br><span class="line">INVALID 表示该封包的连接编号（Session ID）无法辨识或编号不正确。</span><br><span class="line">ESTABLISHED 表示该封包属于某个已经建立的连接。</span><br><span class="line">NEW 表示该封包想要起始一个连接（重设连接或将连接重导向）。</span><br><span class="line">RELATED 表示该封包是属于某个已经建立的连接，所建立的新连接。例如：FTP-DATA 连接必定是源自某个 FTP 连接。</span><br></pre></td></tr></table></figure></p>
<p>4）[-j target/jump] 常用的处理动作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-j 参数用来指定要进行的处理动作，常用的处理动作包括：ACCEPT、REJECT、DROP、REDIRECT、MASQUERADE、LOG、DNAT、SNAT、MIRROR、QUEUE、RETURN、MARK，分别说明如下：</span><br><span class="line">ACCEPT： 将封包放行，进行完此处理动作后，将不再匹配其它规则，直接跳往下一个规则链（natostrouting）。</span><br><span class="line">REJECT： 拦阻该封包，并传送封包通知对方，可以传送的封包有几个选择：ICMP port-unreachable、ICMP echo-reply 或是tcp-reset（这个封包会要求对方关闭 连接），进行完此处理动作后，将不再匹配其它规则，直接中断过滤程序。 范例如下：iptables -A FORWARD -p TCP --dport 22 -j REJECT --reject-with tcp-reset</span><br><span class="line">DROP： 丢弃封包不予处理，进行完此处理动作后，将不再匹配其它规则，直接中断过滤程序。</span><br><span class="line">REDIRECT： 将封包重新导向到另一个端口（PNAT），进行完此处理动作后，将会继续匹配其它规则。 这个功能可以用来实现透明代理或用来保护 web 服务器。例如：iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080</span><br><span class="line">MASQUERADE： 改写封包来源 IP 为防火墙 NIC IP，可以指定 port 对应的范围，进行完此处理动作后，直接跳往下一个规则 链（manglepostrouting）。这个功能与SNAT 略有不同，当进行 IP 伪装时，不需指定要伪装成哪个 IP，IP会从网卡直接读取，当使用拨 号接连时，IP通常是由ISP公司的DHCP 服务器指派的，这个时候 MASQUERADE 特别有用。范例如下：iptables -t nat -A POSTROUTING -p TCP -j MASQUERADE --to-ports 1024-31000</span><br><span class="line">LOG： 将封包相关讯息纪录在 /var/log 中，详细位置请查阅 /etc/syslog.conf 配置文件，进行完此处理动作后，将会继续匹配其规则。例如：iptables -A INPUT -p tcp -j LOG --log-prefix &quot;INPUT packets&quot;</span><br><span class="line">SNAT： 改写封包来源 IP 为某特定 IP 或 IP 范围，可以指定 port 对应的范围，进行完此处理动作后，将直接跳往下一个规则（mangleostrouting）。范例如下：iptables -t nat -A POSTROUTING -p tcp -o eth0 -j SNAT --to-source?194.236.50.155-194.236.50.160:1024-32000</span><br><span class="line">DNAT： 改写封包目的地 IP 为某特定 IP 或 IP 范围，可以指定 port 对应的范围，进行完此处理动作后，将会直接跳往下一个规则链（filter:input 或 filter:forward）。范例如下：iptables -t nat -A PREROUTING -p tcp -d 15.45.23.67 --dport 80 -j DNAT --to-destination 192.168.1.1-192.168.1.10:80-100</span><br><span class="line">MIRROR： 镜射封包，也就是将来源 IP 与目的地 IP 对调后，将封包送回，进行完此处理动作后，将会中断过滤程序。</span><br><span class="line">QUEUE： 中断过滤程序，将封包放入队列，交给其它程序处理。通过自行开发的处理程序，可以进行其它应用，例如：计算连接费用等。</span><br><span class="line">RETURN： 结束在目前规则链中的过滤程序，返回主规则链继续过滤，如果把自定义规则链看成是一个子程序，这个动作则就相当于提前结束子程序并返回到主程序中。</span><br><span class="line">MARK： 将封包标上某个代号，以便提供作为后续过滤的条件判断依据，进行完此处理动作后，将会继续匹配其它规则。范例如下：iptables -t mangle -A PREROUTING -p tcp --dport 22 -j MARK --set-mark 2</span><br></pre></td></tr></table></figure></p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>现在较新的linux版本基本都使用firewalld，因为它更加强大，这里不用它<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install iptables-services #安装iptables</span><br><span class="line">systemctl enable iptables #开机启动</span><br><span class="line">systemctl start|stop|restart iptables #启动、停止、重启iptables</span><br></pre></td></tr></table></figure></p>
<p>1）查看系统中iptables中已经有的规则，知道如何关闭和启用这些规则<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -L #查看现有防火墙所有策略</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# service iptables status #查看iptables状态</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/04/04/5ca572fc35954.png" alt="1.png"><br><strong>禁止ping</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -A INPUT -p icmp -j DROP #在INPUT链中增加一条规则（丢弃ICMP包）</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/04/04/5ca576af89756.png" alt="2.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -A INPUT -p icmp -j REJECT #(返回一个终止数据包，拒绝连接动作)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/04/04/5ca577a6c7cdf.png" alt="3.png"></p>
<blockquote>
<ul>
<li>REJECT是一种更符合规范的处理方式，并且在可控的网络环境中，更易于诊断和调试网络/防火墙所产生的问题；</li>
<li>DROP则提供了更高的防火墙安全性和稍许的效率提高，但是由于DROP不很规范(不很符合TCP连接规范)的处理方式，可能<br>会对你的网络造成一些不可预期或难以诊断的问题。</li>
</ul>
</blockquote>
<p><strong>防御DDos</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -A INPUT -p tcp --dport 端口 -j DROP #短时间接收大量tcp数据包端口</span><br></pre></td></tr></table></figure></p>
<p>DDos仍然是很难防御的攻击<br><strong>防御SSH爆破</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --name SSH --update --seconds 60 --hitcount 3 -j DROP</span><br><span class="line">[root@localhost ~]# iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --name SSH --set -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>对于ssh的新连接，将加入ssh列表中，一分钟超过3次错误连接，将拉入黑名单，并丢弃后续这个IP地址的请求包</p>
<h2 id="Firewalld构建动态防火墙"><a href="#Firewalld构建动态防火墙" class="headerlink" title="Firewalld构建动态防火墙"></a>Firewalld构建动态防火墙</h2><p>Firewalld 是新一 Linux 代防火墙工具，它提供了支持网络 / 防火墙区域 (zone) 定义网络链接以及接口安全等级的动态防火墙管理工具。它也支持允许服务或者应用程序直接添加防火墙规则的接口。<br><a href="https://blog.csdn.net/qq_36492368/article/details/80432259" target="_blank" rel="noopener">firewalld详解</a></p>
<h3 id="Firewalls两大特性"><a href="#Firewalls两大特性" class="headerlink" title="Firewalls两大特性"></a>Firewalls两大特性</h3><blockquote>
<ul>
<li>1）firewalld支持动态更新，不用重启服务，随时添加规则，随时生效，这个过程不需要重新装载netfilter内核模块，但是要求所有的规则都通过firewalld守护进程来实现，以确保守护进程内的防火墙状态和内核中的防火墙状态一致；守护进程firewalld，应用程序、守护进程和用户可以通过D-BUS请求一个防火墙特性，特性可以是预定义的防火墙功能，例如：服务、端口和协议的组合、端口/数据报转发、伪装、ICMP拦截或自定义的规则。原有的静态防火墙规则还可以继续使用，但是不能和firewalld同时存在，需要使用这两者中的任何一个时，停止另外一个的使用。</li>
<li>2)加入了区域（zone）的概念<br>区域定义了网络连接的可信等级，这是一个一对多的关系，意味着一次连接可以仅仅是一个区域的一部分，一个区域可以用于很多连接。</li>
</ul>
</blockquote>
<p><strong>firewalld 防火墙堆栈示意图:</strong><br><img src="https://i.loli.net/2019/04/04/5ca5949fc4ce4.png" alt="4.png"></p>
<h3 id="对网络区的理解"><a href="#对网络区的理解" class="headerlink" title="对网络区的理解:"></a>对网络区的理解:</h3><p>由firewalld 提供的区域按照从不信任到信任的顺序排序:</p>
<blockquote>
<ul>
<li>drop（丢弃）<br>任何接收的网络数据包都被丢弃，没有任何回复。仅能有发送出去的网络连接。</li>
<li>block（限制）<br>任何接收的网络连接都被 IPv4 的 icmp-host-prohibited 信息和 IPv6 的 icmp6-adm-prohibited 信息所拒绝。</li>
<li>public（公共）<br>在公共区域内使用，不能相信网络内的其他计算机不会对您的计算机造成危害，只能接收经过选取的连接。</li>
<li>external（外部）<br>特别是为路由器启用了伪装功能的外部网。您不能信任来自网络的其他计算，不能相信它们不会对您的计算机造成危害，只能接收经过选择的连接。</li>
<li>dmz（非军事区）<br>用于您的非军事区内的电脑，此区域内可公开访问，可以有限地进入您的内部网络，仅仅接收经过选择的连接。</li>
<li>work（工作）<br>用于工作区。您可以基本相信网络内的其他电脑不会危害您的电脑。仅仅接收经过选择的连接。</li>
<li>home（家庭）<br>用于家庭网络。您可以基本信任网络内的其他计算机不会危害您的计算机。仅仅接收经过选择的连接。</li>
<li>internal（内部）<br>用于内部网络。您可以基本上信任网络内的其他计算机不会威胁您的计算机。仅仅接受经过选择的连接。</li>
<li>trusted（信任）<br>可接受所有的网络连接。</li>
</ul>
</blockquote>
<p>安装时，firewalld 里的默认区域被设定为公共区域。<br><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/security_guide/sec-using_firewalls" target="_blank" rel="noopener">RHEL7安全性指南4.5. 使用防火墙</a><a href="https://blog.csdn.net/xiazichenxi/article/details/80169927" target="_blank" rel="noopener">firewalld简单使用</a></p>
<h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl start firewalld #启动Firewalls</span><br><span class="line">[root@localhost ~]# firewall-cmd --state #检查是否可以连接后台</span><br></pre></td></tr></table></figure>
<p><strong>区域相关设置</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --get-zones #列出支持的区域列表</span><br><span class="line">[root@localhost ~]# firewall-cmd --get-active-zones #查看当前的区域</span><br><span class="line">[root@localhost ~]# firewall-cmd --set-default-zone=home  #将区域改为home</span><br><span class="line">[root@localhost ~]# firewall-cmd --get-zone-of-interface=ens33 查看接口区域</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=FedoraWorkstation --list-interfaces #查看FedoraWorkstation区域的接口</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=FedoraWorkstation --list-all #列出FedoraWorkstation区域的所有设置</span><br><span class="line">FedoraWorkstation (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: ens33</span><br><span class="line">  sources:</span><br><span class="line">  services: dhcpv6-client ssh samba-client mdns</span><br><span class="line">  ports: 1025-65535/udp 1025-65535/tcp</span><br><span class="line">  protocols:</span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports:</span><br><span class="line">  source-ports:</span><br><span class="line">  icmp-blocks:</span><br><span class="line">  rich rules:</span><br></pre></td></tr></table></figure></p>
<p><strong>应急模式</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --panic-on #阻止所有网络链接：</span><br><span class="line">[root@localhost ~]# firewall-cmd --panic-off #恢复链接：</span><br><span class="line">[root@localhost ~]# firewall-cmd --query-panic #查看是否启用应急模式</span><br></pre></td></tr></table></figure></p>
<p><strong>重载防火墙</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --reload #重新加载防火墙,并不中断用户连接，即不丢失状态信息</span><br><span class="line">[root@localhost ~]# firewall-cmd --complete-reload #重新加载防火墙并中断用户连接，即丢弃状态信息(一般用于防火墙出现严重问题，如：重新加载防火墙并中断用户连接，即丢弃状态信息)</span><br></pre></td></tr></table></figure></p>
<p><strong>端口</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --zone=FedoraWorkstation --list-ports #列出FedoraWorkstation区域所有开放的端口</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --add-port=444-555/tcp #将某个或者多个端口加入某区域</span><br></pre></td></tr></table></figure></p>
<p><strong>服务</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --get-services #列出支持的服务</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=FedoraWorkstation --list-services #列出FedoraWorkstation区域启用的服务</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --add-service=smtp #将某服务加入某区域</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --remove-service=smtp #从区域移除服务</span><br></pre></td></tr></table></figure></p>
<p><strong>IP伪装</strong>：私有网络地址被隐藏并映射到一个公有IP，常用于路由<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --zone=home --add-masquerade #允许伪装IP</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=zone --query-masquerade #检查区域是否启用ip伪装功能</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=zone --remove-masquerade #禁用伪装IP</span><br></pre></td></tr></table></figure></p>
<p><strong>ICMP阻塞</strong>：阻止一个或多个 ICMP 类型（这里阻塞ECHO Reply包）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --get-icmptypes #支持的ICMP类型</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --add-icmp-block=echo-reply #开启ICMP阻塞</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home -- --remove-icmp-block==echo-reply #禁用ICMP阻塞</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home ---query-icmp-block==echo-reply #查看ICMP阻塞状态</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/04/07/5ca9d3a835829.png" alt="5.png"><br>注：ping包ECHO REQUEST和ECHO REPLY<br><strong>端口转发</strong><br>端口转发需要先开启IP伪装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --zone=home --add-forward-port=port=80:proto=tcp:toport =8080 #将本机80端口转发至8080端口</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --add-forward-port=port=80:proto=tcp:toaddr=192.168.67.130 #将本机映射到另外一个地址上的相同端口</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --add-forward-port=port=80:proto=tcp:toport=8080:toaddr=192.168.67.130 #将本机映射到另外一个地址上的不同端口</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --remove-forward-port=port=80:proto=tcp:toport =8080 #删除本机80端口转发至8080端口</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --remove-forward-port=port=80:proto=tcp:toremover=192.168.67.130 #删除本机映射到另外一个地址上的相同端口</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --remove-forward-port=port=80:proto=tcp:toport=8080:toremover=192.168.67.130 #删除本机映射到另外一个地址上的不同端口</span><br><span class="line">[root@localhost ~]# firewall-cmd --zone=home --query-forward-port=port=80:proto=tcp:topo rt=8080 #查看某区域内的端口转发</span><br></pre></td></tr></table></figure></p>
<p><strong>设置永久保留</strong><br>上述是临时的配置，重载后配置将不再保留，如果需要将设置永久保留，则需要使用–permanent 选项。只有在增加 –permanent 选项并重新加载防火墙，永久选项才会生效<br>如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --permanent --zone=home --add-port=80/tcp</span><br></pre></td></tr></table></figure></p>
<h3 id="高级设置"><a href="#高级设置" class="headerlink" title="高级设置"></a>高级设置</h3><p>1、<strong>使用XML文件配置防火墙</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat /usr/lib/firewalld/services/smtp.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;service&gt;</span><br><span class="line">  &lt;short&gt;Mail (SMTP)&lt;/short&gt;</span><br><span class="line">  &lt;description&gt;This option allows incoming SMTP mail delivery. If you need to allow remote hosts to connect directly to your machine to deliver mail, enable this option. You do not need to enable this if you collect your mail from your ISP&apos;s server by POP3 or IMAP, or if you use a tool such as fetchmail. Note that an improperly configured SMTP server can allow remote machines to use your server to send spam.&lt;/description&gt;</span><br><span class="line">  &lt;port protocol=&quot;tcp&quot; port=&quot;25&quot;/&gt;</span><br><span class="line">&lt;/service&gt;</span><br></pre></td></tr></table></figure></p>
<p>能看出每一个服务定义都需要一个简短的名字、描述和端口网络用于指定需要使用的协议、端口和模块名<br>使用此结构，自定义服务配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /usr/lib/firewalld/services/test.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;service&gt;</span><br><span class="line">        &lt;short&gt;TEST&lt;/short&gt;</span><br><span class="line">        &lt;description&gt;This is Test&lt;/description&gt;</span><br><span class="line">        &lt;port port=&quot;4444&quot; protocol=&quot;tcp&quot;/&gt;</span><br><span class="line">&lt;/service&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --reload </span><br><span class="line">[root@localhost ~]# firewall-cmd --get-services</span><br></pre></td></tr></table></figure>
<p>接下来就可以将服务加入区域之类的<br><img src="https://i.loli.net/2019/04/08/5caabeb25b5e0.png" alt="6.png"><br><a href="https://twoerner.fedorapeople.org/firewalld/doc/firewalld.icmptype.html" target="_blank" rel="noopener">firewalld.icmptype(5)</a> 操作手册 — 描述了 ICMP 过滤的 XML 配置文件。<br><a href="https://twoerner.fedorapeople.org/firewalld/doc/firewalld.service.html" target="_blank" rel="noopener">firewalld.service(5)</a> 操作手册 — 描述了 firewalld service 的 XML 配置文件。<br><a href="https://twoerner.fedorapeople.org/firewalld/doc/firewalld.zones.html" target="_blank" rel="noopener">firewalld.zone(5)</a> 操作手册 — 描述了配置 firewalld 区域的 XML 配置文件。</p>
<p>2、<strong>firewall-cmd –direct(firewalld直接接口) </strong><br>使用–direct在运行时间里增加或者移除链，命令立刻生效，但重载后失效。传递的参数 <args> 与 iptables, ip6tables 以及 ebtables 一致<br><a href="https://twoerner.fedorapeople.org/firewalld/doc/firewall-cmd.html" target="_blank" rel="noopener">firewall-cmd操作</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --direct --get-rules ipv4 filter INPUT #列出INPUT链中的规则</span><br></pre></td></tr></table></figure></args></p>
<p>3、<strong>使用Rich Language配置复杂防火墙规则</strong><br>可以用比直接接口方式更易理解的方法建立复杂防火墙规则，<a href="https://fedoraproject.org/wiki/Features/FirewalldRichLanguage/zh-cn" target="_blank" rel="noopener">Firewalld Rich Language 文档</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --help | grep &quot;rule&quot;</span><br><span class="line">  --list-rich-rules    List rich language rules added for a zone [P] [Z]</span><br><span class="line">  --add-rich-rule=&lt;rule&gt;</span><br><span class="line">                       Add rich language rule &apos;rule&apos; for a zone [P] [Z] [T]</span><br><span class="line">  --remove-rich-rule=&lt;rule&gt;</span><br><span class="line">                       Remove rich language rule &apos;rule&apos; from a zone [P] [Z]</span><br><span class="line">  --query-rich-rule=&lt;rule&gt;</span><br><span class="line">                       Return whether a rich language rule &apos;rule&apos; has been</span><br><span class="line">  --get-all-rules</span><br><span class="line">                       Get all rules [P]</span><br><span class="line">  --get-rules &#123;ipv4|ipv6|eb&#125; &lt;table&gt; &lt;chain&gt;</span><br><span class="line">                       Get all rules added to chain in table [P]</span><br><span class="line">  --add-rule &#123;ipv4|ipv6|eb&#125; &lt;table&gt; &lt;chain&gt; &lt;priority&gt; &lt;arg&gt;...</span><br><span class="line">                       Add rule to chain in table [P]</span><br><span class="line">  --remove-rule &#123;ipv4|ipv6|eb&#125; &lt;table&gt; &lt;chain&gt; &lt;priority&gt; &lt;arg&gt;...</span><br><span class="line">                       Remove rule with priority from chain in table [P]</span><br><span class="line">  --remove-rules &#123;ipv4|ipv6|eb&#125; &lt;table&gt; &lt;chain&gt;</span><br><span class="line">                       Remove rules from chain in table [P]</span><br><span class="line">  --query-rule &#123;ipv4|ipv6|eb&#125; &lt;table&gt; &lt;chain&gt; &lt;priority&gt; &lt;arg&gt;...</span><br><span class="line">                       Return whether a rule with priority has been added to</span><br><span class="line">                       Get all tracked passthrough rules [P]</span><br><span class="line">                       Get tracked passthrough rules [P]</span><br><span class="line">                       Add a new tracked passthrough rule [P]</span><br><span class="line">                       Remove a tracked passthrough rule [P]</span><br><span class="line">                       Return whether the tracked passthrough rule has been</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">增加一项规则：firewall-cmd [--zone=zone] --add-rich-rule=&apos;rule&apos;</span><br><span class="line">移除一项规则：firewall-cmd [--zone=zone] --remove-rich-rule=&apos;rule&apos;</span><br><span class="line">检查一项规则是否存在：firewall-cmd [--zone=zone] --query-rich-rule=&apos;rule&apos;</span><br></pre></td></tr></table></figure>
<p>举个列子：<br>允许从 192.168.67.130 到 web 服务器（80 号端口）的连接而阻塞 192.168.67.0/24 网络中的其它来源<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --add-rich-rule &apos;rule family=&quot;ipv4&quot; source address=&quot;192 .168.67.130/24&quot; service name=&quot;http&quot; accept&apos;</span><br><span class="line">[root@localhost ~]# firewall-cmd --add-rich-rule &apos;rule family=&quot;ipv4&quot; source address=&quot;192 .168.67.0/24&quot; service name=&quot;http&quot; drop&apos;</span><br></pre></td></tr></table></figure></p>
<p>–permanent永久生效<br>4、<strong>“Rich Language”多规则结构</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule [family=&quot;&lt;rule family&gt;&quot;]</span><br><span class="line">	[ source address=&quot;&lt;address&gt;&quot; [invert=&quot;True&quot;] ]</span><br><span class="line">	destination address=&quot;&lt;address&gt;&quot; [invert=&quot;True&quot;] ]</span><br><span class="line">	[ &lt;element&gt; ]</span><br><span class="line">	[log [prefix=&quot;&lt;prefix text&gt;&quot;] [level=&quot;&lt;log level&gt;&quot;][limitvalue=&quot;rate/duration&quot;] ]</span><br><span class="line">	[ audit ]</span><br><span class="line">	[ accept|reject|drop ]</span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li>source<br>源地址</li>
<li>sourcedestination<br>目标地址。</li>
<li>sourceservice<br>服务名称是 firewalld 提供的其中一种服务。命令为以下形式:<br>sourceservice name=service_name</li>
<li>port<br>可以是一个具体的端口，也可以是端口范围，例如，5060-5062。协议可以指定为 tcp 或 udp。命令为以下形式：<br>port port=number_or_range protocol=protocol</li>
<li>protocol<br>协议值可以是一个协议 ID 数字，或者一个协议名。预知可用协议，请查阅 /etc/protocols。命令为以下形式：<br>protocol value=protocol_name_or_ID</li>
<li>icmp-block<br>用这个命令阻绝一个或多个 ICMP 类型。 ICMP 类型是 firewalld 支持的 ICMP 类型之一。要获得被支持的 ICMP 类型列表，输入以下命令：<br>irewall-cmd –get-icmptypes<br>命令为以下形式<br>icmp-block name=icmptype_name</li>
<li>masquerade<br>打开规则里的 IP 伪装。</li>
<li>forward-port<br>从一个带有指定为 tcp 或 udp 协议的本地端口转发数据包到另一个本地端口，或另一台机器，或另一台机器上的另一个端口。 port 和 to-port 可以是一个单独的端口数字，或一个端口范围。而目的地址是一个简单的 IP 地址。这个命令为以下形式：<br>forward-port port=number_or_range protocol=protocol / to-port=number_or_range to-addr=address</li>
<li>log<br>写入日志，等级可以是 emerg 、 alert 、 crit 、 error 、warning 、 notice、 info 或者 debug 中的一个。语法如下：<br>log [prefix=prefix text] [level=log level] limit value=rate/duration<br>日志等级用正的自然数 [1, ..] 表达，持续时间的单位为 s 、 m 、 h 、 d 。 s 表示秒， m 表示分钟， h 表示小时， d 表示天。最大限定值是 1/d ，意为每天最多有一条日志。</li>
<li>audit<br>审核为发送到 auditd 服务。审核类型可以是 ACCEPT 、 REJECT 或 DROP 中的一种，但不能在 audit 命令后指定，因为审核类型将会从规则动作中自动收集。审核不包含自身参数，但可以选择性地增加限制。审核的使用是可选择的。</li>
<li>accept|reject|drop<br>规则动作。<br>accept | reject [type=reject type] | drop<br>选择 accept 所有新的连接请求都会被允许。选择 reject ，连接将被拒绝，连接来源将接到一个拒绝信息。选择 drop ， 所有数据包会被丢弃，并且不会向来源地发送任何信息。</li>
</ul>
</blockquote>
<p>列如:同意来自 192.168.0.0/24 网络的IP地址使用ipv4访问本机的http，并且每一分钟写入一次系统日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd --add-rich-rule &apos;rule family=&quot;ipv4&quot; source address=&quot;192.168.0.0/24&quot; service name=&quot;http&quot; log prefix=&quot;http&quot; level=&quot;info&quot; limit value=&quot;1/m&quot; accept&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="到此结束"><a href="#到此结束" class="headerlink" title="到此结束"></a>到此结束</h2><p>如有错误请联系<a href="mailto:lanbaidetanlang@qq.com" target="_blank" rel="noopener">lanbaidetanlang@qq.com</a><br><img src="https://i.loli.net/2019/04/04/5ca58a69f1e58.png" alt="d9d46d06022fb2745c849ca766a2878d.png"></p>

      
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2019/04/04/2019-04-04/">Linux防火墙-iptables/firewalld</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 EV 的个人博客">EV</a></p>
        <p><span>发布时间:</span>2019年04月04日 - 00时00分</p>
        <p><span>最后更新:</span>2019年04月08日 - 13时09分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2019/04/04/2019-04-04/" title="Linux防火墙-iptables/firewalld">http://www.lanbainan.cn/2019/04/04/2019-04-04/</a>
            <span class="copy-path" data-clipboard-text="原文: http://www.lanbainan.cn/2019/04/04/2019-04-04/　　作者: EV" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2019/04/10/2019-04-10/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          对于DC-1的测试
        
      </div>
    </a>
  
  
    <a href="/2019/04/03/2019-04-03/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">中间人攻击-ARP毒化</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables"><span class="toc-number">1.</span> <span class="toc-text">iptables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#语法"><span class="toc-number">1.1.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本使用"><span class="toc-number">1.2.</span> <span class="toc-text">基本使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewalld构建动态防火墙"><span class="toc-number">2.</span> <span class="toc-text">Firewalld构建动态防火墙</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Firewalls两大特性"><span class="toc-number">2.1.</span> <span class="toc-text">Firewalls两大特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对网络区的理解"><span class="toc-number">2.2.</span> <span class="toc-text">对网络区的理解:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本命令"><span class="toc-number">2.3.</span> <span class="toc-text">基本命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#高级设置"><span class="toc-number">2.4.</span> <span class="toc-text">高级设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#到此结束"><span class="toc-number">3.</span> <span class="toc-text">到此结束</span></a></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>






<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
      <section id="comments">
  <div id="valine_thread" style="margin: 30px;"></div>
        <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
        <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
        <script>
            var GUEST_INFO = ['nick','mail','link'];
            var guest_info = 'nick,mail,link'.split(',').filter(function(item){
                return GUEST_INFO.indexOf(item) > -1
            });
            var notify = 'true' == true;
            var verify = 'true' == true;
            var valine = new Valine();
            valine.init({
                el: '#valine_thread',
                notify: notify,
                verify: verify,
                appId: "AphjXIvvoDr8mPjQaDqYnoGg-gzGzoHsz",
                appKey: "wVPDX41uy60qD4RljgWFY7hy",
                placeholder: "评论一下,Ctrl+Enter回复",
                pageSize:'10',
                avatar:'robohash',
                lang:'zh-cn'
            })
        </script>
</section>

    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2019/04/10/2019-04-10/" title="上一篇: 对于DC-1的测试">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2019/04/03/2019-04-03/" title="下一篇: 中间人攻击-ARP毒化">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/06/12/2019-06-12/">XOR编码实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/04/2019-06-04/">将Hex转换为base64</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/30/2019-05-30/">对于DC-5和DC-6的测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/2019-05-23/">对于DC-2和DC-4的测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/16/2019-04-16/">对于Billu_b0x的测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/15/2019-04-15/">对于JIS-CTF-Vuln的测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/13/2019-04-13/">HEXO持续优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/12/2019-04-12/">对于unknowndevice64的测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/2019-04-11/">CommandoVM测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/10/2019-04-10/">对于DC-1的测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/04/2019-04-04/">Linux防火墙-iptables/firewalld</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/03/2019-04-03/">中间人攻击-ARP毒化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/28/2019-3-28/">Sqls-Libs闯关（基础版）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/26/2019-3-26/">Mysql加固</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/21/2019-1-21/">在cgi模式下的phpmyadmin</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/18/2019-1-18/">Web渗透</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/12/2018-11-12/">提权</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/16/2018-10-16/">缓冲区溢出</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/08/2018-09-08/">使用Python爬虫打造翻译工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/21/2018-8-21/">主动信息收集</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/29/2018-07-29/">Python爬虫学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/25/2018-7-22/">被动信息收集</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/25/hexo/">搭建hexo博客的坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/25/netcat/">NETCAT学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/25/Python1/">Python的类型与运算一</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/25/hello-world/">Hello World</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 EV
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >小站到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    </div>
    <script src="//cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>




	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?ef5d51eef2343ca823c8c93e3b66057c";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>



  </div>
<!--搞怪标题-->
<script type="text/javascript" src="/js/crash_cheat.js"></script>
<!--点击小红心-->
<script type="text/javascript" src="/js/clicklove.js"></script>
<!--看板娘-->
<script src="/live2d-widget/autoload.js"></script>
</body>
</html>
